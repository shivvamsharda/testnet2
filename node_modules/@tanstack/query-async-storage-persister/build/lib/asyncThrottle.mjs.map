{"version":3,"file":"asyncThrottle.mjs","sources":["../../src/asyncThrottle.ts"],"sourcesContent":["export interface AsyncThrottleOptions {\n  interval?: number\n  onError?: (error: unknown) => void\n}\n\nconst noop = () => {\n  /* do nothing */\n}\n\nexport function asyncThrottle<Args extends readonly unknown[]>(\n  func: (...args: Args) => Promise<void>,\n  { interval = 1000, onError = noop }: AsyncThrottleOptions = {},\n) {\n  if (typeof func !== 'function') throw new Error('argument is not function.')\n\n  let running = false\n  let lastTime = 0\n  let timeout: ReturnType<typeof setTimeout>\n  let currentArgs: Args | null = null\n\n  const execFunc = async () => {\n    if (currentArgs) {\n      const args = currentArgs\n      currentArgs = null\n      try {\n        running = true\n        await func(...args)\n      } catch (error) {\n        onError(error)\n      } finally {\n        lastTime = Date.now() // this line must after 'func' executed to avoid two 'func' running in concurrent.\n        running = false\n      }\n    }\n  }\n\n  const delayFunc = async () => {\n    clearTimeout(timeout)\n    timeout = setTimeout(() => {\n      if (running) {\n        delayFunc() // Will come here when 'func' execution time is greater than the interval.\n      } else {\n        execFunc()\n      }\n    }, interval)\n  }\n\n  return (...args: Args) => {\n    currentArgs = args\n\n    const tooSoon = Date.now() - lastTime < interval\n    if (running || tooSoon) {\n      delayFunc()\n    } else {\n      execFunc()\n    }\n  }\n}\n"],"names":["noop","asyncThrottle","func","interval","onError","Error","running","lastTime","timeout","currentArgs","execFunc","args","error","Date","now","delayFunc","clearTimeout","setTimeout","tooSoon"],"mappings":"AAKA,MAAMA,IAAI,GAAG,MAAM;AACjB;AACD,CAFD,CAAA;;AAIO,SAASC,aAAT,CACLC,IADK,EAEL;AAAEC,EAAAA,QAAQ,GAAG,IAAb;AAAmBC,EAAAA,OAAO,GAAGJ,IAAAA;AAA7B,CAAA,GAA4D,EAFvD,EAGL;EACA,IAAI,OAAOE,IAAP,KAAgB,UAApB,EAAgC,MAAM,IAAIG,KAAJ,CAAU,2BAAV,CAAN,CAAA;EAEhC,IAAIC,OAAO,GAAG,KAAd,CAAA;EACA,IAAIC,QAAQ,GAAG,CAAf,CAAA;AACA,EAAA,IAAIC,OAAJ,CAAA;EACA,IAAIC,WAAwB,GAAG,IAA/B,CAAA;;EAEA,MAAMC,QAAQ,GAAG,YAAY;AAC3B,IAAA,IAAID,WAAJ,EAAiB;MACf,MAAME,IAAI,GAAGF,WAAb,CAAA;AACAA,MAAAA,WAAW,GAAG,IAAd,CAAA;;MACA,IAAI;AACFH,QAAAA,OAAO,GAAG,IAAV,CAAA;AACA,QAAA,MAAMJ,IAAI,CAAC,GAAGS,IAAJ,CAAV,CAAA;OAFF,CAGE,OAAOC,KAAP,EAAc;QACdR,OAAO,CAACQ,KAAD,CAAP,CAAA;AACD,OALD,SAKU;AACRL,QAAAA,QAAQ,GAAGM,IAAI,CAACC,GAAL,EAAX,CADQ;;AAERR,QAAAA,OAAO,GAAG,KAAV,CAAA;AACD,OAAA;AACF,KAAA;GAbH,CAAA;;EAgBA,MAAMS,SAAS,GAAG,YAAY;IAC5BC,YAAY,CAACR,OAAD,CAAZ,CAAA;IACAA,OAAO,GAAGS,UAAU,CAAC,MAAM;AACzB,MAAA,IAAIX,OAAJ,EAAa;AACXS,QAAAA,SAAS,GADE;AAEZ,OAFD,MAEO;QACLL,QAAQ,EAAA,CAAA;AACT,OAAA;KALiB,EAMjBP,QANiB,CAApB,CAAA;GAFF,CAAA;;EAWA,OAAO,CAAC,GAAGQ,IAAJ,KAAmB;AACxBF,IAAAA,WAAW,GAAGE,IAAd,CAAA;IAEA,MAAMO,OAAO,GAAGL,IAAI,CAACC,GAAL,EAAaP,GAAAA,QAAb,GAAwBJ,QAAxC,CAAA;;IACA,IAAIG,OAAO,IAAIY,OAAf,EAAwB;MACtBH,SAAS,EAAA,CAAA;AACV,KAFD,MAEO;MACLL,QAAQ,EAAA,CAAA;AACT,KAAA;GARH,CAAA;AAUD;;;;"}